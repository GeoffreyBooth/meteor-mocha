var page, system;

page = require('webpage').create();
var fs = require('fs');
system = require('system');
console.log("phantomjs: Using file " + system.env.TEST_FILE + " to compare.");
var compare = fs.read(system.env.TEST_FILE);
console.log("phantomjs: Running tests at " + system.env.ROOT_URL);

page.onConsoleMessage = function (message) {
  console.log(message);
};

page.open(system.env.ROOT_URL, function(status) {console.log("status:", status)});

page.onError = function (msg, trace) {
  var mochaIsRunning;
  mochaIsRunning = page.evaluate(function () {
    return window.mochaIsRunning;
  });
  if (mochaIsRunning) {
    return;
  }
  console.log("phantomjs: " + msg);
  trace.forEach(function (item) {
    console.log("    " + item.file + ": " + item.line);
  });
  phantom.exit(6);
};

setInterval(function () {
  var done, failures;
  done = page.evaluate(function () {
    if (typeof TEST_STATUS !== "undefined" && TEST_STATUS !== null) {
      return TEST_STATUS.DONE;
    }
    if (typeof DONE !== "undefined" && DONE !== null) {
      return DONE;
    }
    return false;
  });
  if (done) {
    var html = page.evaluate(function () {
      // We don't care about the duration of tests. We make them '0'
      var duration = document.querySelectorAll(".duration");
      for(var i = 0; i < duration.length; i++){
        duration[i].innerHTML = "0";
      }
      return document.querySelector(".mocha-wrapper").innerHTML;
    });
    // Remove changing strings
    var regex = new RegExp("/local\\?", "g");
    console.log("regex.local:", regex);
    console.log("regex.local.match:", html.match(regex).length);
    html = html.replace(regex, "/?");

    regex = new RegExp("http://localhost:3000", "g");
    console.log("regex.localhost:", regex);
    // console.log("regex.localhost.match:", compare.match(regex).length);
    compare = compare.replace(regex, system.env.ROOT_URL);
    console.log("regex.localhost.match:", compare.match(regex) && compare.match(regex).length);

    regex = new RegExp("hash=[^\\n|^<]*", "g");
    console.log("regex.hash:", regex);
    console.log("regex.hash.match:", html.match(regex).length);
    html = html.replace(regex, "hash=a");

    return phantom.exit( !(compare == html));
  }
}, 500);

// ---
// generated by coffee-script 1.9.2